<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NASA Weather Probability Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<style>
/* same styles as before */
* { box-sizing: border-box; font-family: "Poppins", sans-serif; }
body { margin:0; display:flex; flex-direction:row; height:100vh; background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); color:#fff; overflow:hidden; }
.sidebar { width:55%; background: rgba(255,255,255,0.1); backdrop-filter: blur(12px); padding:20px; display:flex; flex-direction:column; overflow-y:auto; }
h1 { text-align:center; font-size:24px; margin-bottom:15px; }
label { font-size:15px; margin-top:14px; display:block; }
input, select, button { width:100%; padding:10px; margin-top:6px; border:none; border-radius:8px; }
input[type="text"], input[type="number"], input[type="date"], select { background: rgba(255,255,255,0.9); color:#000; }
input[type="range"] { width:100%; }
button { background:#0078ff; color:white; font-weight:bold; cursor:pointer; transition: background 0.3s; margin-top:10px; }
button:hover { background:#005ecb; }
#map { width:45%; height:100%; border-left:2px solid rgba(255,255,255,0.2); }
.output { background: rgba(0,0,0,0.6); padding:15px; border-radius:12px; margin-top:20px; text-align:center; }
.coords { margin-top:5px; font-size:14px; text-align:center; color:#cfdfff; }
canvas { background:#fff; border-radius:10px; margin-top:15px; width:100% !important; height:400px !important; }
@media (max-width:1000px) { body { flex-direction:column; } .sidebar { width:100%; height:60%; } #map { width:100%; height:40%; } }
</style>
</head>
<body>

<div class="sidebar">
  <h1>üåç NASA Weather Probability</h1>

  <label>üîç Find a place</label>
  <input type="text" id="searchBox" placeholder="Enter city name..." />
  <button id="searchBtn">Go</button>
  <button id="locBtn">Use My Location</button>
  <button id="drawBtn">Draw Area</button>

  <div class="coords" id="coords">No location selected</div>

  <label>üìÖ Select date</label>
  <input type="date" id="datePicker" />
  <label>or choose day of year</label>
  <input type="range" id="daySlider" min="1" max="365" value="180" />
  <div>Day: <span id="dayVal">180</span> | Season: <span id="season">Summer</span></div>

  <label>üå°Ô∏è Variable</label>
  <select id="variable">
    <option value="temperature">Temperature (¬∞C)</option>
    <option value="precipitation">Precipitation (mm)</option>
    <option value="windspeed">Windspeed (m/s)</option>
    <option value="airquality">Air Quality Index (AQI)</option>
  </select>

  <label>‚öôÔ∏è Threshold</label>
  <input type="number" id="threshold" value="30" />

  <button id="analyzeBtn">Analyze Probability</button>
  <div class="output" id="output">
    <p>Select a location and variable to begin.</p>
    <canvas id="chart"></canvas> <!-- permanent canvas -->
  </div>
  <button id="downloadBtn">‚¨áÔ∏è Download CSV</button>
</div>

<div id="map"></div>

<script>
const map = L.map("map").setView([20,78],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let marker = null;
const redIcon = L.icon({ iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize:[36,36], iconAnchor:[18,36] });

function updateCoords(lat,lng){
  document.getElementById("coords").textContent = `üìç Selected: ${lat.toFixed(3)}, ${lng.toFixed(3)}`;
}

// map click
map.on("click",(e)=>{ if(marker) map.removeLayer(marker); marker=L.marker(e.latlng,{icon:redIcon}).addTo(map); updateCoords(e.latlng.lat,e.latlng.lng); });

// search
document.getElementById("searchBtn").onclick=async()=>{
  const place=document.getElementById("searchBox").value; if(!place) return;
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${place}`);
  const data=await res.json();
  if(data.length){ const {lat,lon}=data[0]; map.setView([lat,lon],10); if(marker) map.removeLayer(marker); marker=L.marker([lat,lon],{icon:redIcon}).addTo(map); updateCoords(+lat,+lon); }
};

// use location
document.getElementById("locBtn").onclick=()=>{
  if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>{ const lat=pos.coords.latitude; const lon=pos.coords.longitude; map.setView([lat,lon],10); if(marker) map.removeLayer(marker); marker=L.marker([lat,lon],{icon:redIcon}).addTo(map); updateCoords(lat,lon); }); }
};

// date handling
const daySlider=document.getElementById("daySlider");
const dayVal=document.getElementById("dayVal");
const season=document.getElementById("season");
const datePicker=document.getElementById("datePicker");

daySlider.oninput=()=>{ const day=+daySlider.value; dayVal.textContent=day; season.textContent=getSeason(day); };
datePicker.oninput=()=>{ const date=new Date(datePicker.value); const start=new Date(date.getFullYear(),0,0); const diff=date-start; const oneDay=1000*60*60*24; const day=Math.floor(diff/oneDay); daySlider.value=day; dayVal.textContent=day; season.textContent=getSeason(day); };
function getSeason(day){ if(day<80)return"Winter"; if(day<172)return"Spring"; if(day<266)return"Summer"; if(day<355)return"Autumn"; return"Winter"; }

// Chart instance
let chart = null;

// Analyze button
document.getElementById("analyzeBtn").onclick = async () => {
  if(!marker) return alert("Please select a location first!");
  const variable=document.getElementById("variable").value;
  const day=+daySlider.value;
  const lat=marker.getLatLng().lat;
  const lon=marker.getLatLng().lng;

  const res=await fetch("/api/auto_threshold",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({variable,lat,lon,day}) });
  const data=await res.json();
  const threshold=data.threshold;
  const samples=data.samples;

  document.getElementById("threshold").value=threshold;
  const prob=(samples.filter(x=>x>threshold).length/samples.length)*100;

  const output=document.getElementById("output");
  output.querySelector('p').innerHTML = `Auto Threshold: <b>${threshold}</b> | Probability: <b>${prob.toFixed(1)}%</b>`;

  const ctx=document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels:samples.map((_,i)=>i+1),
      datasets:[{ label:`${variable} samples`, data:samples, borderColor:"#00d4ff", backgroundColor:"rgba(0,212,255,0.3)", fill:true, tension:0.3 }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:false } } }
  });

  window.latestAnalysis={variable,threshold,samples,prob};
};

// Download CSV
document.getElementById("downloadBtn").onclick=()=>{
  if(!window.latestAnalysis) return alert("No analysis yet!");
  const {variable,threshold,samples,prob}=window.latestAnalysis;
  const csv=[["Variable",variable],["Threshold",threshold],["Probability (%)",prob.toFixed(2)],[],["Sample","Value"],...samples.map((v,i)=>[i+1,v.toFixed(2)])].map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="weather_probability.csv"; a.click();
};
</script>
</body>
</html>
